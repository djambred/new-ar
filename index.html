<!doctype html>

<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>ThreeJS AR (Markerless) - siatang animasi</title>
    <style>
      html, body { height: 100%; margin: 0; overflow: hidden; font-family: system-ui, Arial; }
      #container { width: 100%; height: 100%; position: relative; }
      #ui { position: absolute; left: 16px; top: 16px; z-index: 10; color: white; }
      button { font-size: 16px; padding: 8px 12px; }
      #msg { position: absolute; left: 16px; bottom: 16px; z-index: 10; color: white; background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 6px; }
      canvas { display: block; }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <div id="ui"><button id="enter-ar">Masuk AR</button></div>
    <div id="msg">Ketuk layar untuk meletakkan model setelah AR aktif.</div>

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/loaders/GLTFLoader.js';
  import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/webxr/ARButton.js';

  let camera, scene, renderer;
  let reticle, controller;
  let model;
  let placed = false;
  let wavePhase = 0;
  const clock = new THREE.Clock();

  init();

  function init() {
    const container = document.getElementById('container');
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    container.appendChild(renderer.domElement);

    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
    scene.add(light);

    reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.08, 0.12, 32).rotateX(-Math.PI / 2),
      new THREE.MeshBasicMaterial({ color: 0x00ff00 })
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    controller = renderer.xr.getController(0);
    controller.addEventListener('select', onSelect);
    scene.add(controller);

    const loader = new GLTFLoader();
    loader.load('assets/models/siatang-new.glb', gltf => {
      model = gltf.scene;
      model.visible = false;
      model.scale.set(0.5, 0.5, 0.5);
      scene.add(model);

      // Audio
      const listener = new THREE.AudioListener();
      camera.add(listener);
      const audioLoader = new THREE.AudioLoader();
      const posAudio = new THREE.PositionalAudio(listener);
      audioLoader.load('assets/sounds/welcome.mp3', buffer => {
        posAudio.setBuffer(buffer);
        posAudio.setRefDistance(1);
        posAudio.setLoop(false);
      });
      model.add(posAudio);
    }, undefined, e => console.error('GLB load error', e));

    const button = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
    document.getElementById('enter-ar').addEventListener('click', async () => {
      try {
        const sessionInit = { requiredFeatures: ['hit-test'] };
        const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
        renderer.xr.setSession(session);

        const refSpace = await session.requestReferenceSpace('viewer');
        const hitTestSource = await session.requestHitTestSource({ space: refSpace });
        const localRefSpace = await session.requestReferenceSpace('local');

        renderer.setAnimationLoop(function (timestamp, frame) {
          if (frame) {
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0 && !placed) {
              const hit = hitTestResults[0];
              const pose = hit.getPose(localRefSpace);
              reticle.visible = true;
              reticle.matrix.fromArray(pose.transform.matrix);
            } else if (!placed) {
              reticle.visible = false;
            }
            animateModel();
            render();
          }
        });

        controller.addEventListener('select', () => {
          if (!reticle.visible || !model) return;
          model.position.setFromMatrixPosition(reticle.matrix);
          model.rotation.y = camera.rotation.y;
          model.visible = true;
          placed = true;

          const posAudio = model.children.find(c => c.type === 'Audio');
          if (posAudio && posAudio.isPlaying === false) posAudio.play();
        });

      } catch (err) {
        console.error('Gagal memulai AR session', err);
        alert('AR tidak tersedia: ' + err.message);
      }
    });

    window.addEventListener('resize', onWindowResize);
  }

  function onSelect() {}

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animateModel() {
    const delta = clock.getDelta();
    if (model && placed) {
      // rotasi lembut
      model.rotation.y += delta * 0.6;

      // efek lambaian seperti naik-turun halus
      wavePhase += delta * 2;
      model.position.y += Math.sin(wavePhase) * 0.002;
    }
  }

  function render() {
    renderer.render(scene, camera);
  }
</script>

  </body>
</html>
